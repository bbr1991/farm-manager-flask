{% extends "base.html" %}
{% block title %}Record New Sale (POS){% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-cart4 me-2"></i>Point of Sale</h2>

<form action="{{ url_for('add_sale_post') }}" method="POST" id="complete-sale-form">
    <div class="row">
        <!-- Left Side: Item Selection & Current Sale -->
        <div class="col-lg-7">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- Item Selection Row -->
                    <div class="row g-2 align-items-end border-bottom pb-3 mb-3">
                        <div class="col-sm-6"><label for="item-selector" class="form-label">Select Product Package</label><select class="form-select" id="item-selector"><option selected disabled value="">-- Choose a package --</option>{% for item in inventory_items %}<option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-name="{{ item.package_name }}">{{ item.package_name }} - ₦{{ '{:,.2f}'.format(item.sale_price) }}</option>{% endfor %}</select></div>
                        <div class="col-sm-3"><label for="quantity-selector" class="form-label">Quantity</label><input type="number" class="form-control" id="quantity-selector" step="1" min="1" value="1"></div>
                        <div class="col-sm-3"><button type="button" class="btn btn-primary w-100" id="add-item-btn"><i class="bi bi-plus-lg"></i> Add to Sale</button></div>
                    </div>

                    <!-- Sale Summary Table -->
                    <h5 class="mb-3">Items in Current Sale</h5>
                    <table class="table table-sm">
                        <thead><tr><th>Item</th><th class="text-center">Qty</th><th class="text-end">Subtotal</th><th></th></tr></thead>
                        <tbody id="sale-items-table"><tr id="no-items-row"><td colspan="4" class="text-center text-muted p-4">No items added yet.</td></tr></tbody>
                        <tfoot><tr class="table-group-divider"><th colspan="2" class="text-end fs-5">Grand Total:</th><th class="text-end fs-5" id="grand-total">₦0.00</th><th></th></tr></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Side: Payment and Completion -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Payment Details</h5></div>
                <div class="card-body">
                    <!-- NEW MULTI-PAYMENT SECTION -->
                    <div class="row g-2 align-items-end border-bottom pb-3 mb-3">
                        <div class="col-sm-6"><label class="form-label">Payment Account</label><select class="form-select" id="payment-account-selector">{% for account in asset_accounts %}<option value="{{ account.id }}">{{ account.name }}</option>{% endfor %}</select></div>
                        <div class="col-sm-4"><label class="form-label">Amount (₦)</label><input type="number" step="0.01" class="form-control" id="payment-amount-input"></div>
                        <div class="col-sm-2"><button type="button" class="btn btn-secondary w-100" id="add-payment-btn">Add</button></div>
                    </div>
                    
                    <h5 class="mb-3">Payments Applied</h5>
                    <table class="table table-sm">
                        <thead><tr><th>Account</th><th class="text-end">Amount</th><th></th></tr></thead>
                        <tbody id="payment-items-table"><tr id="no-payments-row"><td colspan="3" class="text-center text-muted p-3">No payments applied yet.</td></tr></tbody>
                    </table>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between fs-5 mb-3">
                        <span>Total Paid:</span>
                        <strong id="total-paid">₦0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between fs-5 mb-3">
                        <span>Balance Due:</span>
                        <strong id="balance-due" class="text-danger">₦0.00</strong>
                    </div>
                    <!-- END OF NEW SECTION -->

                    <hr class="my-4">
                    <input type="date" class="form-control mb-3" id="date" name="date" required>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" type="submit">Complete Sale</button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden inputs for form submission -->
    <div id="hidden-items-container"></div>
    <div id="hidden-payments-container"></div>
    <input type="hidden" name="total_amount" id="hidden-total-amount" value="0">
</form> 
{% endblock %}


{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Item selection elements
        const addItemBtn = document.getElementById('add-item-btn');
        const itemSelect = document.getElementById('item-selector');
        const quantityInput = document.getElementById('quantity-selector');
        const saleItemsTable = document.getElementById('sale-items-table');
        const noItemsRow = document.getElementById('no-items-row');
        const grandTotalEl = document.getElementById('grand-total');

        // Payment selection elements
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const paymentAccountSelect = document.getElementById('payment-account-selector');
        const paymentAmountInput = document.getElementById('payment-amount-input');
        const paymentItemsTable = document.getElementById('payment-items-table');
        const noPaymentsRow = document.getElementById('no-payments-row');
        const totalPaidEl = document.getElementById('total-paid');
        const balanceDueEl = document.getElementById('balance-due');

        // Hidden form elements
        const hiddenItemsContainer = document.getElementById('hidden-items-container');
        const hiddenPaymentsContainer = document.getElementById('hidden-payments-container');
        const hiddenTotalAmountInput = document.getElementById('hidden-total-amount');

        document.getElementById('date').valueAsDate = new Date();

        let saleItems = [];
        let paymentItems = [];
        let saleItemIndex = 0;
        let paymentItemIndex = 0;

        // --- Event Listeners ---
        addItemBtn.addEventListener('click', addItemToSale);
        addPaymentBtn.addEventListener('click', addPaymentToSale);
        
        saleItemsTable.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                const row = e.target.closest('tr');
                removeItemFromSale(parseInt(row.dataset.index, 10));
            }
        });

        paymentItemsTable.addEventListener('click', (e) => {
            if (e.target.closest('.remove-payment-btn')) {
                const row = e.target.closest('tr');
                removePaymentFromSale(parseInt(row.dataset.index, 10));
            }
        });

        // --- Core Functions ---
        function calculateTotals() {
            const grandTotal = saleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalPaid = paymentItems.reduce((sum, p) => sum + p.amount, 0);
            const balanceDue = grandTotal - totalPaid;

            grandTotalEl.textContent = `₦${grandTotal.toFixed(2)}`;
            totalPaidEl.textContent = `₦${totalPaid.toFixed(2)}`;
            balanceDueEl.textContent = `₦${balanceDue.toFixed(2)}`;
            
            balanceDueEl.classList.toggle('text-danger', balanceDue > 0);
            balanceDueEl.classList.toggle('text-success', balanceDue <= 0);

            hiddenTotalAmountInput.value = grandTotal.toFixed(2);
        }

        // --- Sale Item Functions ---
        function addItemToSale() {
            const option = itemSelect.options[itemSelect.selectedIndex];
            const quantity = parseFloat(quantityInput.value);
            if (!option || option.value === "" || !quantity || quantity <= 0) return;
            
            saleItems.push({ id: option.value, name: option.dataset.name, price: parseFloat(option.dataset.price), quantity: quantity, index: saleItemIndex++ });
            renderSaleTable();
        }
        function removeItemFromSale(index) {
            saleItems = saleItems.filter(item => item.index !== index);
            renderSaleTable();
        }
        function renderSaleTable() {
            saleItemsTable.innerHTML = '';
            hiddenItemsContainer.innerHTML = '';
            if (saleItems.length === 0) saleItemsTable.appendChild(noItemsRow);
            else {
                saleItems.forEach((item, i) => {
                    const subtotal = item.price * item.quantity;
                    const row = saleItemsTable.insertRow();
                    row.dataset.index = item.index;
                    row.innerHTML = `<td>${item.name}</td><td class="text-center">${item.quantity}</td><td class="text-end">₦${subtotal.toFixed(2)}</td><td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-item-btn">×</button></td>`;
                    hiddenItemsContainer.innerHTML += `<input type="hidden" name="items[${i}][id]" value="${item.id}"><input type="hidden" name="items[${i}][quantity]" value="${item.quantity}">`;
                });
            }
            calculateTotals();
        }

        // --- Payment Item Functions ---
        function addPaymentToSale() {
            const option = paymentAccountSelect.options[paymentAccountSelect.selectedIndex];
            const amount = parseFloat(paymentAmountInput.value);
            if (!option || option.value === "" || !amount || amount <= 0) return;

            paymentItems.push({ accountId: option.value, accountName: option.textContent, amount: amount, index: paymentItemIndex++ });
            renderPaymentTable();
            paymentAmountInput.value = '';
        }
        function removePaymentFromSale(index) {
            paymentItems = paymentItems.filter(p => p.index !== index);
            renderPaymentTable();
        }
        function renderPaymentTable() {
            paymentItemsTable.innerHTML = '';
            hiddenPaymentsContainer.innerHTML = '';
            if (paymentItems.length === 0) paymentItemsTable.appendChild(noPaymentsRow);
            else {
                paymentItems.forEach((p, i) => {
                    const row = paymentItemsTable.insertRow();
                    row.dataset.index = p.index;
                    row.innerHTML = `<td>${p.accountName}</td><td class="text-end">₦${p.amount.toFixed(2)}</td><td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-payment-btn">×</button></td>`;
                    hiddenPaymentsContainer.innerHTML += `<input type="hidden" name="payments[${i}][account_id]" value="${p.accountId}"><input type="hidden" name="payments[${i}][amount]" value="${p.amount}">`;
                });
            }
            calculateTotals();
        }
    });
    </script>
{% endblock %}