{% block scripts %}
<script src="{{ url_for('static', filename='js/idb.js') }}"></script>
<script>
    // Wait until the entire page is loaded before running our script
    document.addEventListener('DOMContentLoaded', (event) => {
        console.log("DOM fully loaded and parsed");

        const expenseForm = document.getElementById('expense-form');
        if (!expenseForm) {
            console.error("Critical error: Could not find #expense-form!");
            return;
        }
        console.log("Found form:", expenseForm);

        expenseForm.addEventListener('submit', (submitEvent) => {
            console.log("Form submission event triggered.");
            
            // Always prevent the default submission right away
            submitEvent.preventDefault();

            // Now, check the network status
            if (navigator.onLine) {
                // If we are ONLINE, we submit the form normally.
                console.log("Network status: ONLINE. Submitting to server.");
                expenseForm.submit();
            } else {
                // If we are OFFLINE, we save to IndexedDB.
                console.log("Network status: OFFLINE. Saving to IndexedDB.");

                const formData = new FormData(expenseForm);
                const expenseData = {
                    date: formData.get('date'),
                    description: formData.get('description'),
                    amount: formData.get('amount'),
                    payment_account_id: formData.get('payment_account_id'),
                    expense_category_id: formData.get('expense_category_id')
                };
                console.log("Offline data captured:", expenseData);

                saveExpense(expenseData)
                    .then(() => navigator.serviceWorker.ready)
                    .then(registration => registration.sync.register('sync-new-expenses'))
                    .then(() => {
                        console.log("Background sync registered successfully.");
                        alert("You are offline. Expense saved locally. It will sync automatically when you reconnect.");
                        window.location.href = "{{ url_for('dashboard') }}";
                    })
                    .catch(error => {
                        console.error("Error saving expense locally:", error);
                        alert("Could not save the expense locally. Please check the console for errors.");
                    });
            }
        });
    });
</script>
{% endblock %}