{% extends "base.html" %}
{% block title %}Batch Customer Deposits{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2"><i class="bi bi-stack me-2"></i>Batch Customer Deposits</h1>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        Enter multiple customer payments received on the same day into the same account.
    </div>
    <div class="card-body">
        <form action="{{ url_for('batch_deposit_post') }}" method="POST">
            <!-- Main Deposit Info -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="date" class="form-label">Deposit Date</label>
                    <input type="date" class="form-control" name="date" value="{{ today_date }}" required>
                </div>
                <div class="col-md-6">
                    <label for="deposit_account_id" class="form-label">Deposit Into (Cash/Bank Account)</label>
                    <select class="form-select" name="deposit_account_id" id="deposit_account_id" required>
                        <option value="" disabled selected>-- Select account --</option>
                        {% for account in asset_accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Dynamic Table for Individual Payments -->
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%;">Received From (Customer)</th>
                        <th style="width: 25%;">Amount (₦)</th>
                        <th style="width: 30%;">Memo / Reference</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="batch-table-body">
                    <!-- Rows will be added here by JavaScript -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">
                            <button type="button" class="btn btn-secondary btn-sm" id="add-row-btn">
                                <i class="bi bi-plus-lg"></i> Add Payment Line
                            </button>
                        </td>
                    </tr>
                    <tr class="table-group-divider">
                        <th class="text-end">Total Deposit:</th>
                        <th id="total-deposit" class="fs-5">₦0.00</th>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
            
            <hr class="my-4">
            <button type="submit" class="btn btn-primary btn-lg">Post Batch</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const addRowBtn = document.getElementById('add-row-btn');
        const tableBody = document.getElementById('batch-table-body');
        const totalDepositEl = document.getElementById('total-deposit');
        let rowIndex = 0;

        // Pre-populate the customer options for the dropdown
        const customerOptions = `
            <option value="" disabled selected>-- Select a customer --</option>
            {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
        `;

        function addRow() {
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><select class="form-select form-select-sm" name="tx[${rowIndex}][customer_id]" required>${customerOptions}</select></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm amount-input" name="tx[${rowIndex}][amount]" required></td>
                <td><input type="text" class="form-control form-control-sm" name="tx[${rowIndex}][memo]"></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">×</button></td>
            `;
            rowIndex++;
        }

        function calculateTotal() {
            let total = 0;
            const amountInputs = tableBody.querySelectorAll('.amount-input');
            amountInputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            totalDepositEl.textContent = `₦${total.toFixed(2)}`;
        }

        addRowBtn.addEventListener('click', addRow);

        tableBody.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-row-btn')) {
                e.target.closest('tr').remove();
                calculateTotal();
            }
        });

        tableBody.addEventListener('input', function(e) {
            if (e.target && e.target.classList.contains('amount-input')) {
                calculateTotal();
            }
        });

        // Add one row to start with
        addRow();
    });
    </script>
{% endblock %}